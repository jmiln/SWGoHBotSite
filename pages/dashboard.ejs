<!DOCTYPE html>
<html lang="en">
    <head>
        <%- include("../partials/head") -%>
    </head>

    <body>
        <header>
            <%- include("../partials/nav") -%>
        </header>

        <main class="page-wrapper" id="main-content">
            <div class="column w80 autoMargin" style="padding-top: 2rem; padding-bottom: 2rem;">
                <h1>Welcome, <%= user.username %>!</h1>

                <% if (!userConfig) { %>
                    <p>No configuration found — start using the bot in Discord to set up your profile.</p>
                <% } else { %>

                    <!-- Linked Accounts -->
                    <section class="config-section">
                        <h2>Linked Accounts</h2>
                        <% if (userConfig.accounts && userConfig.accounts.length) { %>
                            <div class="config-sort">
                                <span class="config-sort-label">Sort by</span>
                                <button class="config-sort-btn active" data-sort="name" aria-pressed="true">Name</button>
                                <button class="config-sort-btn" data-sort="char" aria-pressed="false">Char Rank</button>
                                <button class="config-sort-btn" data-sort="ship" aria-pressed="false">Ship Rank</button>
                            </div>
                            <table class="config-table" id="linked-accounts-table">
                                <thead>
                                    <tr>
                                        <th scope="col">Name</th>
                                        <th scope="col">Ally Code</th>
                                        <th scope="col">Char Arena</th>
                                        <th scope="col">Ship Arena</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% userConfig.accounts.forEach(function(acct) { %>
                                    <tr data-name="<%= escapeAttr(acct.name.toLowerCase()) %>" data-char="<%= acct.lastCharRank != null ? acct.lastCharRank : '' %>" data-ship="<%= acct.lastShipRank != null ? acct.lastShipRank : '' %>">
                                        <td title="<%= escapeAttr(acct.name) %>"><%= acct.name %> <% if (acct.primary) { %><span class="badge-primary">Primary</span><% } %></td>
                                        <td class="config-muted"><%= acct.allyCode %></td>
                                        <td><%= acct.lastCharRank != null ? "#" + acct.lastCharRank : "—" %></td>
                                        <td><%= acct.lastShipRank != null ? "#" + acct.lastShipRank : "—" %></td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        <% } else { %>
                            <p class="config-muted">No accounts linked.</p>
                        <% } %>
                    </section>

                    <!-- Language -->
                    <section class="config-section">
                        <h2>Language</h2>
                        <div class="config-row">
                            <span class="config-label">Bot Language</span>
                            <span><%= userConfig.lang && userConfig.lang.language ? userConfig.lang.language : "Default" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">SWGoH Language</span>
                            <span><%= userConfig.lang && userConfig.lang.swgohLanguage ? userConfig.lang.swgohLanguage : "Default" %></span>
                        </div>
                    </section>

                    <!-- Arena Alerts -->
                    <section class="config-section">
                        <h2>Arena Alerts</h2>
                        <div class="config-row">
                            <span class="config-label">Rank DMs</span>
                            <span><%= userConfig.arenaAlert && userConfig.arenaAlert.enableRankDMs === "on" ? "Enabled" : "Disabled" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Arena Type</span>
                            <span><%= userConfig.arenaAlert && userConfig.arenaAlert.arena ? userConfig.arenaAlert.arena : "—" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Payout Warning</span>
                            <span><%= userConfig.arenaAlert && userConfig.arenaAlert.payoutWarning != null ? userConfig.arenaAlert.payoutWarning + " min" : "—" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Payout Result</span>
                            <span><%= userConfig.arenaAlert && userConfig.arenaAlert.enablePayoutResult ? "Enabled" : "Disabled" %></span>
                        </div>
                    </section>

                    <!-- Arena Watch -->
                    <section class="config-section">
                        <h2>Arena Watch</h2>
                        <div class="config-row">
                            <span class="config-label">Status</span>
                            <span><%= userConfig.arenaWatch && userConfig.arenaWatch.enabled ? "Enabled" : "Disabled" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Report Style</span>
                            <span><%= userConfig.arenaWatch && userConfig.arenaWatch.report ? userConfig.arenaWatch.report : "—" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Show vs</span>
                            <span><%= userConfig.arenaWatch && userConfig.arenaWatch.showvs ? "Yes" : "No" %></span>
                        </div>
                        <% if (userConfig.arenaWatch && userConfig.arenaWatch.allycodes && userConfig.arenaWatch.allycodes.length) { %>
                            <div class="config-sort">
                                <span class="config-sort-label">Sort by</span>
                                <button class="config-sort-btn active" data-sort="name" aria-pressed="true">Name</button>
                                <button class="config-sort-btn" data-sort="char" aria-pressed="false">Char Rank</button>
                                <button class="config-sort-btn" data-sort="ship" aria-pressed="false">Ship Rank</button>
                                <button class="config-sort-btn" data-sort="payout" aria-pressed="false">Payout</button>
                            </div>
                            <table class="config-table" id="arena-watch-table">
                                <thead>
                                    <tr>
                                        <th scope="col">Name</th>
                                        <th scope="col">Ally Code</th>
                                        <th scope="col">Char Arena</th>
                                        <th scope="col">Ship Arena</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% userConfig.arenaWatch.allycodes.forEach(function(wa) { %>
                                    <% var pt = wa.poOffset != null ? formatPayoutTimes(wa.poOffset) : null; %>
                                    <tr data-name="<%= escapeAttr(wa.name.toLowerCase()) %>" data-char="<%= wa.lastChar %>" data-ship="<%= wa.lastShip %>" data-po-offset="<%= wa.poOffset != null ? wa.poOffset : '' %>">
                                        <td title="<%= escapeAttr(wa.name) %>"><%= wa.name %></td>
                                        <td class="config-muted"><%= wa.allyCode != null ? wa.allyCode : (wa.allycode != null ? wa.allycode : "—") %></td>
                                        <td>#<%= wa.lastChar %><% if (pt) { %><span class="config-payout"><%= pt.char %></span><% } %></td>
                                        <td>#<%= wa.lastShip %><% if (pt) { %><span class="config-payout"><%= pt.fleet %></span><% } %></td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        <% } %>
                    </section>

                    <!-- Guild Update -->
                    <section class="config-section">
                        <h2>Guild Update</h2>
                        <div class="config-row">
                            <span class="config-label">Status</span>
                            <span><%= userConfig.guildUpdate && userConfig.guildUpdate.enabled ? "Enabled" : "Disabled" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Ally Code</span>
                            <span><%= userConfig.guildUpdate && userConfig.guildUpdate.allycode != null ? userConfig.guildUpdate.allycode : "—" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Sort By</span>
                            <span><%= userConfig.guildUpdate && userConfig.guildUpdate.sortBy ? userConfig.guildUpdate.sortBy : "—" %></span>
                        </div>
                    </section>

                    <!-- Guild Tickets -->
                    <section class="config-section">
                        <h2>Guild Tickets</h2>
                        <div class="config-row">
                            <span class="config-label">Status</span>
                            <span><%= userConfig.guildTickets && userConfig.guildTickets.enabled ? "Enabled" : "Disabled" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Sort By</span>
                            <span><%= userConfig.guildTickets && userConfig.guildTickets.sortBy ? userConfig.guildTickets.sortBy : "—" %></span>
                        </div>
                        <div class="config-row">
                            <span class="config-label">Show Max</span>
                            <span><%= userConfig.guildTickets && userConfig.guildTickets.showMax ? "Yes" : "No" %></span>
                        </div>
                    </section>

                <% } %>
            </div>
        </main>

        <script src="/js/dashboard.js" nonce="<%= nonce %>"></script>
        <%- include("../partials/footer") -%>
    </body>
</html>
